<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猫の往診用 事前問診フォーム</title>
    <!-- Tailwind CSS と アイコンライブラリ(Lucide) をCDN経で読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* アコーディオンのアニメーション */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .accordion-content.open {
            max-height: 2000px; /* 十分な高さを確保 */
        }
        /* タブのスタイル */
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
        /* チェックボックスとラジオボタンのカスタムスタイル */
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:disabled {
            background-color: #e5e7eb;
            border-color: #d1d5db;
        }
        /* 印刷時用のスタイル */
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none;
            }
            main, .container {
                padding: 0 !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <!-- ===== 入力フォームページ ===== -->
        <div id="form-page">
            <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-800">
                            このフォームは、<strong>事前に往診のお申し込みが完了している方専用</strong>です。
                        </p>
                    </div>
                </div>
            </div>

            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">往診 事前問診フォーム</h1>
                <p class="mt-2 text-gray-600">往診前に必要な猫たちの情報をご入力ください。</p>
            </header>

            <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-10">
                <!-- Step 1: 基本情報 -->
                <div id="step1">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-blue-500 pl-4">基本情報</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="applicantName" class="block text-sm font-medium text-gray-700 mb-1">申込者氏名</label>
                            <input type="text" id="applicantName" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="山田 花子">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-start pt-2">
                            <div>
                                <label for="catCount" class="block text-sm font-medium text-gray-700 mb-1">受診する猫の総数</label>
                                <input type="number" id="catCount" min="1" value="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label for="firstVisitCount" class="block text-sm font-medium text-gray-700 mb-1">そのうち初診の猫の数</label>
                                <input type="number" id="firstVisitCount" min="0" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <p class="text-xs text-gray-500 mt-1">（当院の往診が初めてで、カルテ作成が必要な子の数）</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: 猫ごとの情報入力 -->
                <div id="step2">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-blue-500 pl-4">猫ちゃんたちの情報</h2>
                    <div id="cat-info-container" class="space-y-6">
                        <!-- 猫の情報フォームがここに追加されます -->
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button id="remove-cat-button" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition flex items-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                            <i data-lucide="minus" class="w-4 h-4 mr-1"></i>
                            <span>最後の猫を削除</span>
                        </button>
                        <button id="add-cat-button" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition flex items-center text-sm">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                            <span>猫を追加</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: 検査項目選択 -->
                <div id="step3">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-blue-500 pl-4">ご希望の診察・検査内容</h2>
                    <div id="cat-tabs" class="mb-4 border-b border-gray-200"></div>
                    <div id="exam-container" class="space-y-4"></div>
                </div>
            </main>

            <footer class="sticky bottom-0 mt-8 bg-white/80 backdrop-blur-sm border-t border-gray-200 p-4 rounded-t-2xl shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)]">
                <div class="max-w-4xl mx-auto flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600">概算合計金額 (税込)</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-900" id="total-price">0 円</p>
                    </div>
                    <button id="show-confirm-button" class="bg-blue-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all transform hover:scale-105">
                        内容を確認する
                    </button>
                </div>
            </footer>
        </div>

        <!-- ===== 確認ページ ===== -->
        <div id="confirmation-page" class="hidden">
             <header class="text-center mb-8 no-print">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">ご入力内容の確認</h1>
                <p class="mt-2 text-gray-600">以下の内容で送信します。よろしければ送信ボタンを押してください。</p>
            </header>
            <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div id="confirmation-summary" class="space-y-6">
                    <!-- 確認内容がここに表示されます -->
                </div>
                 <div class="mt-8 pt-6 border-t no-print">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="printer" class="h-5 w-5 text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    控えとして、このページを<strong>印刷</strong>または<strong>PDFとして保存</strong>することをお勧めします。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 no-print">
                    <button id="edit-button" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition flex items-center justify-center">
                        <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i>
                        修正する
                    </button>
                     <button id="print-button" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition flex items-center justify-center">
                        <i data-lucide="printer" class="w-4 h-4 mr-2"></i>
                        印刷する
                    </button>
                    <button id="final-submit-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <span id="final-submit-text">この内容で送信する</span>
                        <div id="final-submit-loader" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                        <i data-lucide="send" class="w-4 h-4 ml-2"></i>
                    </button>
                </div>
            </main>
        </div>
        
        <!-- ===== 送信完了ページ ===== -->
        <div id="success-page" class="hidden">
            <main class="bg-white p-8 sm:p-12 rounded-2xl shadow-lg text-center">
                <i data-lucide="check-circle-2" class="w-16 h-16 text-green-500 mx-auto"></i>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mt-6">送信が完了しました</h1>
                <p class="mt-4 text-gray-600 max-w-md mx-auto">ご入力ありがとうございました。内容を確認の上、担当者よりご連絡いたします。</p>
                <button id="return-to-form-button" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition">
                    最初の画面に戻る
                </button>
            </main>
        </div>
    </div>
    
    <!-- モーダル (説明用) -->
    <div id="description-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-900"></h3>
                    <button class="modal-close-button text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div id="modal-content" class="text-gray-600 space-y-2 prose"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ★★★★★ ここにApps Scriptで取得したウェブアプリのURLを貼り付けます ★★★★★
            const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx73KdK9l5dyJugL_BR1FKNp9uch0ih4q9pj1LNomM2PB4DdZvNgSs6rhdkGneXfDTMmw/exec'; 
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            // --- 状態管理オブジェクト ---
            let state = {
                applicantName: '',
                catCount: 1,
                firstVisitCount: 0,
                cats: [], // { name, sex, age, weight, exams: {}, symptoms: '', requests: '' }
                activeCatIndex: 0,
            };

            // --- 検査項目データ ---
            const examData = {
                '予防薬': {
                    type: 'radio',
                    items: {
                        'bravecto': { name: 'ブラベクトプラス (3ヶ月毎)', price: 4760, description: 'ノミ・マダニ・お腹の寄生虫（回虫・鉤虫）を駆除。効果が3ヶ月持続します。<br><strong>＜体重別＞</strong><br><small>・1.2kg ~ 2.8kg<br>・2.8kg超 ~ 6.25kg<br>・6.25kg超 ~ 12.5kg</small>' },
                        'revolution': { name: 'レボリューションプラス (1ヶ月毎)', price: 1500, description: 'ノミ・マダニ・お腹の寄生虫（回虫・鉤虫）・フィラリアを予防する標準的なお薬です。毎月1回の投薬です。<br><strong>＜体重別＞</strong><br><small>・2.5kg未満<br>・2.5kg以上 ~ 5.0kg未満<br>・5.0kg以上 ~ 10.0kg未満</small>' },
                        'nexgard': { name: 'ネクスガードキャットコンボ (1ヶ月毎)', price: 2000, description: 'レボリューションプラスのカバー範囲に加え、<strong>お腹の寄生虫（条虫）</strong>にも効果がある、より広範囲な予防薬です。毎月1回の投薬です。<br><strong>＜体重別＞</strong><br><small>・0.8kg ~ 2.5kg未満<br>・2.5kg以上 ~ 7.5kg未満<br>・7.5kg以上 ~ 10.0kg未満</small>' },
                    }
                },
                '血液検査': {
                    type: 'checkbox',
                    items: {
                        'biochem': { name: '生化学19項目 + 血球計算', price: 6000, description: '血液中の様々な成分を測定し、肝臓、腎臓、膵臓などの内臓の健康状態や、貧血、炎症の有無などを総合的に評価します。健康診断の基本となる検査です。<br><strong>＜項目＞</strong><br><small>TP, Alb, A/G比, T-Bil, AST, ALT, ALP, γ-GTP, Lipa, BUN, Cre, T-Cho, TG, Ca, IP, Glu, Na, K, Cl</small>' },
                        't4': { name: '【オプション】T4', price: 3000, description: '甲状腺ホルモンの値を測定します。特に高齢の猫で多く見られる「甲状腺機能亢進症」の診断に役立ちます。飲水量が多い、食欲旺盛なのに痩せてきた、などの症状がある場合におすすめです。', isOption: true },
                        'ga': { name: '【オプション】グリコアルブミン (GA)', price: 3000, description: '過去2〜3週間の平均血糖値を反映する指標です。糖尿病の診断や、治療中のコントロール状態の評価に用いられます。', isOption: true },
                        'saa': { name: '【オプション】炎症マーカーSAA', price: 2000, description: '猫の体内で炎症が起きると急激に増加するタンパク質です。隠れた炎症性疾患や感染症の早期発見、治療効果の判定に役立ちます。', isOption: true }
                    }
                },
                '超音波検査': {
                    type: 'checkbox',
                    items: {
                        'echo': { name: '腹部精査 (+簡易心臓エコー含む)', price: 7000, description: '超音波を使って、お腹の中の臓器（肝臓、腎臓、消化管、膀胱など）の形や内部構造をリアルタイムで観察します。レントゲンではわからない詳細な情報を得ることができます。心臓も簡易的にチェックします。' }
                    }
                },
                '便検査': {
                    type: 'checkbox',
                    items: {
                        'feces_general': { name: '一般糞便検査', price: 2000, description: '顕微鏡で便を直接観察し、消化状態や腸内細菌のバランス、異常な細胞の有無などを調べます。' },
                        'feces_parasite': { name: '寄生虫検査', price: 3000, description: '特殊な検査法を用いて、肉眼では見えない寄生虫の卵や原虫（ジアルジアなど）がいないかを確認します。<br><strong>＜対象＞</strong><br><small>回虫, 鉤虫, 鞭虫, 瓜実条虫, コクシジウム, ジアルジア</small>' },
                        'feces_pcr': { name: 'PCR検査 (下痢パネル)', price: 23000, description: '下痢の原因となる特定のウイルスや細菌、原虫の遺伝子を検出する精密検査です。原因不明の頑固な下痢が続く場合に推奨されます。<br><strong>＜対象＞</strong><br><small>猫コロナウイルス, 猫汎白血球減少症ウイルス, クロストリジウム, ジアルジア, クリプトスポリジウム, サルモネラ, トリコモナス, トキソプラズマ, カンピロバクター</small>' },
                    }
                },
                '尿検査': {
                    type: 'checkbox',
                    items: {
                        'urine': { name: '尿検査', price: 1000, description: '尿の濃さ（比重）や、試験紙を使って尿中の糖、タンパク、潜血などを調べます。腎臓病や膀胱炎、糖尿病などの早期発見に繋がります。' }
                    }
                },
                'ワクチン': {
                    type: 'checkbox',
                    items: {
                        'vaccine': { name: '3種混合ワクチン', price: 4000, description: '猫の日常生活で感染リスクの高い3つの主要なウイルス感染症（猫ウイルス性鼻気管炎, 猫カリシウイルス感染症, 猫汎白血球減少症）を予防します。' }
                    }
                }
            };

            // --- DOM要素の取得 ---
            const formPage = document.getElementById('form-page');
            const confirmationPage = document.getElementById('confirmation-page');
            const successPage = document.getElementById('success-page');
            const applicantNameInput = document.getElementById('applicantName');
            const catCountInput = document.getElementById('catCount');
            const firstVisitCountInput = document.getElementById('firstVisitCount');
            const catInfoContainer = document.getElementById('cat-info-container');
            const addCatButton = document.getElementById('add-cat-button');
            const removeCatButton = document.getElementById('remove-cat-button');
            const catTabs = document.getElementById('cat-tabs');
            const examContainer = document.getElementById('exam-container');
            const totalPriceEl = document.getElementById('total-price');
            const confirmationSummary = document.getElementById('confirmation-summary');
            const showConfirmButton = document.getElementById('show-confirm-button');
            const editButton = document.getElementById('edit-button');
            const printButton = document.getElementById('print-button');
            const finalSubmitButton = document.getElementById('final-submit-button');
            const finalSubmitText = document.getElementById('final-submit-text');
            const finalSubmitLoader = document.getElementById('final-submit-loader');
            const returnToFormButton = document.getElementById('return-to-form-button');
            const descriptionModal = document.getElementById('description-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            // --- レンダリング関数 ---

            function renderCatInfoForms() {
                catInfoContainer.innerHTML = '';
                for (let i = 0; i < state.catCount; i++) {
                    const cat = state.cats[i] || { name: '', sex: '', age: '', weight: '', symptoms: '', requests: '' };
                    const formHTML = `
                        <div class="border border-gray-200 p-4 rounded-lg" data-cat-index="${i}">
                            <p class="font-semibold text-lg mb-3 text-gray-800">${i + 1}匹目の猫ちゃん</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="lg:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                                    <input type="text" data-field="name" value="${cat.name}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="例：タマ">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">性別 (避妊去勢)</label>
                                    <select data-field="sex" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                                        <option value="" ${cat.sex === '' ? 'selected' : ''}>選択</option>
                                        <option value="オス(未去勢)" ${cat.sex === 'オス(未去勢)' ? 'selected' : ''}>オス (未去勢)</option>
                                        <option value="オス(去勢済)" ${cat.sex === 'オス(去勢済)' ? 'selected' : ''}>オス (去勢済)</option>
                                        <option value="メス(未避妊)" ${cat.sex === 'メス(未避妊)' ? 'selected' : ''}>メス (未避妊)</option>
                                        <option value="メス(避妊済)" ${cat.sex === 'メス(避妊済)' ? 'selected' : ''}>メス (避妊済)</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">年齢</label>
                                        <input type="number" data-field="age" value="${cat.age}" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="例：5">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">体重(kg)</label>
                                        <input type="number" data-field="weight" value="${cat.weight}" min="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="例：4.5">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">現在の症状や気になること</label>
                                    <textarea data-field="symptoms" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="例：食欲不振、嘔吐など">${cat.symptoms}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">追加の要望や検査・処置</label>
                                    <textarea data-field="requests" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" placeholder="例：爪切り">${cat.requests}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    catInfoContainer.insertAdjacentHTML('beforeend', formHTML);
                }
            }

            function renderCatTabs() {
                catTabs.innerHTML = '';
                state.cats.forEach((cat, index) => {
                    const catName = cat.name || `猫 ${index + 1}`;
                    const isActive = index === state.activeCatIndex;
                    const buttonHTML = `
                        <button class="tab-button px-4 py-2 text-sm font-medium border-b-2 transition-colors duration-200 ${isActive ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}" data-cat-index="${index}">
                            ${catName}
                        </button>
                    `;
                    catTabs.insertAdjacentHTML('beforeend', buttonHTML);
                });
            }

            function renderExams() {
                examContainer.innerHTML = '';
                const activeCatExams = state.cats[state.activeCatIndex]?.exams || {};

                Object.entries(examData).forEach(([category, data]) => {
                    const accordionHTML = `
                        <div class="border border-gray-200 rounded-lg">
                            <button class="accordion-header w-full flex justify-between items-center p-4 text-left font-semibold text-lg">
                                ${category}
                                <i data-lucide="chevron-down" class="transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content px-4">
                                <div class="py-4 border-t border-gray-200 space-y-4">
                                    ${Object.entries(data.items).map(([key, item]) => {
                                        const isOption = item.isOption;
                                        const isBiochemChecked = activeCatExams['biochem'];
                                        const isDisabled = isOption && !isBiochemChecked;
                                        const labelClasses = isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer';

                                        return `
                                        <label class="flex items-start p-3 rounded-md transition ${labelClasses}">
                                            <input type="${data.type}" name="${category}-${state.activeCatIndex}" value="${key}" data-price="${item.price}" class="custom-checkbox mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${activeCatExams[key] ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                                            <div class="ml-3 text-sm flex-grow">
                                                <span class="font-medium text-gray-900">${item.name}</span>
                                                <p class="text-gray-500">${item.price.toLocaleString()} 円</p>
                                            </div>
                                            <button class="show-description-button text-blue-500 hover:text-blue-700 p-1" data-title="${item.name}" data-description="${item.description}">
                                                <i data-lucide="info" class="w-5 h-5"></i>
                                            </button>
                                        </label>
                                    `}).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    examContainer.insertAdjacentHTML('beforeend', accordionHTML);
                });
                lucide.createIcons();
            }
            
            function renderConfirmation() {
                confirmationSummary.innerHTML = '';
                let catSummaryHTML = '';
                let subtotalExams = 0;

                state.cats.forEach(cat => {
                    const catName = cat.name || '(名前未入力)';
                    let examListHTML = '';
                    let catTotalPrice = 0;

                    Object.entries(cat.exams).forEach(([examKey, isChecked]) => {
                        if (!isChecked) return;
                        
                        for (const category in examData) {
                            if (examData[category].items[examKey]) {
                                const item = examData[category].items[examKey];
                                examListHTML += `<li class="flex justify-between"><span>${item.name}</span><span>${item.price.toLocaleString()} 円</span></li>`;
                                catTotalPrice += item.price;
                                break;
                            }
                        }
                    });
                    subtotalExams += catTotalPrice;

                    if(examListHTML === '') {
                        examListHTML = '<li>検査項目の選択がありません</li>';
                    }

                    catSummaryHTML += `
                        <div class="pb-4 mb-4 border-b last:border-b-0">
                            <h4 class="font-semibold text-lg text-gray-800">${catName} <span class="text-sm font-normal">(${cat.sex || '性別未選択'}, ${cat.age || '?'}歳, ${cat.weight || '?'} kg)</span></h4>
                            <div class="mt-2 pl-4 text-gray-700 space-y-3 text-sm">
                                <div>
                                    <p class="font-semibold">希望検査:</p>
                                    <ul class="pl-2 text-gray-600">${examListHTML}</ul>
                                </div>
                                <div>
                                    <p class="font-semibold">症状・気になること:</p>
                                    <p class="pl-2 whitespace-pre-wrap text-gray-600">${cat.symptoms || '<span class="text-gray-400">入力なし</span>'}</p>
                                </div>
                                <div>
                                    <p class="font-semibold">追加の要望:</p>
                                    <p class="pl-2 whitespace-pre-wrap text-gray-600">${cat.requests || '<span class="text-gray-400">入力なし</span>'}</p>
                                </div>
                            </div>
                            <p class="text-right font-semibold mt-2 text-gray-700">小計: ${catTotalPrice.toLocaleString()} 円</p>
                        </div>
                    `;
                });
                
                const visitFee = 5000;
                const consultationFee = state.catCount * 2000;
                const preTaxTotal = visitFee + consultationFee + subtotalExams;
                const tax = Math.floor(preTaxTotal * 0.1);
                const finalTotal = preTaxTotal + tax;

                const basicInfoHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-900 border-b pb-2">基本情報</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mt-3">
                            <span class="text-gray-600 font-semibold">申込者氏名:</span> <span class="font-medium">${state.applicantName || '<span class="text-gray-400">入力なし</span>'}</span>
                            <span class="text-gray-600 font-semibold">受診総数:</span> <span class="font-medium">${state.catCount} 匹</span>
                            <span class="text-gray-600 font-semibold">うち初診:</span> <span class="font-medium">${state.firstVisitCount} 匹</span>
                        </div>
                    </div>
                `;
                const examsInfoHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-900 border-b pb-2">猫ごとの詳細</h3>
                        <div class="space-y-4 mt-3">${catSummaryHTML}</div>
                    </div>
                `;
                 const pricingHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-900 border-b pb-2">料金概算</h3>
                        <div class="space-y-1 text-sm mt-3">
                            <div class="flex justify-between"><span class="text-gray-600">検査料金 合計:</span> <span>${subtotalExams.toLocaleString()} 円</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">診察料 (${state.catCount}匹):</span> <span>${consultationFee.toLocaleString()} 円</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">往診料:</span> <span>${visitFee.toLocaleString()} 円</span></div>
                            <div class="flex justify-between font-semibold border-t pt-1 mt-1"><span class="text-gray-700">小計 (税抜):</span> <span>${preTaxTotal.toLocaleString()} 円</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">消費税 (10%):</span> <span>${tax.toLocaleString()} 円</span></div>
                            <div class="flex justify-between font-bold text-lg border-t pt-1 mt-1"><span class="text-gray-800">合計 (税込):</span> <span>${finalTotal.toLocaleString()} 円</span></div>
                        </div>
                    </div>
                `;

                confirmationSummary.insertAdjacentHTML('beforeend', basicInfoHTML);
                confirmationSummary.insertAdjacentHTML('beforeend', examsInfoHTML);
                confirmationSummary.insertAdjacentHTML('beforeend', pricingHTML);
                lucide.createIcons();
            }

            function calculateTotal() {
                let subtotalExams = 0;
                state.cats.forEach(cat => {
                    Object.entries(cat.exams).forEach(([examKey, isChecked]) => {
                        if (isChecked) {
                            for (const category in examData) {
                                if (examData[category].items[examKey]) {
                                    subtotalExams += examData[category].items[examKey].price;
                                    break;
                                }
                            }
                        }
                    });
                });
                
                const visitFee = 5000;
                const consultationFee = state.catCount * 2000;
                const preTaxTotal = visitFee + consultationFee + subtotalExams;
                const tax = Math.floor(preTaxTotal * 0.1);
                const finalTotal = preTaxTotal + tax;

                totalPriceEl.textContent = `${finalTotal.toLocaleString()} 円`;
            }

            function updateStateFromDOM() {
                const newCatCount = parseInt(catCountInput.value) || 1;
                
                removeCatButton.disabled = newCatCount <= 1;

                if (newCatCount !== state.catCount) {
                    state.catCount = newCatCount;
                    while (state.cats.length < state.catCount) {
                        state.cats.push({ name: '', sex: '', age: '', weight: '', exams: {}, symptoms: '', requests: '' });
                    }
                    state.cats.length = state.catCount;
                    if (state.activeCatIndex >= state.catCount) {
                        state.activeCatIndex = state.catCount - 1;
                    }
                    renderCatInfoForms();
                    renderCatTabs();
                    renderExams();
                }
                
                state.applicantName = applicantNameInput.value;
                state.firstVisitCount = parseInt(firstVisitCountInput.value) || 0;

                document.querySelectorAll('#cat-info-container > div').forEach((form, index) => {
                    if (state.cats[index]) {
                        state.cats[index].name = form.querySelector('[data-field="name"]').value;
                        state.cats[index].sex = form.querySelector('[data-field="sex"]').value;
                        state.cats[index].age = form.querySelector('[data-field="age"]').value;
                        state.cats[index].weight = form.querySelector('[data-field="weight"]').value;
                        state.cats[index].symptoms = form.querySelector('[data-field="symptoms"]').value;
                        state.cats[index].requests = form.querySelector('[data-field="requests"]').value;
                    }
                });
                
                renderCatTabs();
                calculateTotal();
            }
            
            // --- イベントハンドラ ---
            applicantNameInput.addEventListener('input', updateStateFromDOM);
            catCountInput.addEventListener('change', updateStateFromDOM);
            firstVisitCountInput.addEventListener('change', updateStateFromDOM);
            catInfoContainer.addEventListener('input', updateStateFromDOM);
            
            addCatButton.addEventListener('click', () => {
                const currentCount = parseInt(catCountInput.value);
                catCountInput.value = currentCount + 1;
                updateStateFromDOM();
            });

            removeCatButton.addEventListener('click', () => {
                const currentCount = parseInt(catCountInput.value);
                if (currentCount > 1) {
                    catCountInput.value = currentCount - 1;
                    updateStateFromDOM();
                }
            });

            examContainer.addEventListener('change', (e) => {
                if (e.target.matches('input[type="radio"], input[type="checkbox"]')) {
                    const key = e.target.value;
                    const isChecked = e.target.checked;
                    const catExams = state.cats[state.activeCatIndex].exams;

                    if (e.target.type === 'radio' && isChecked) {
                        const category = Object.keys(examData).find(cat => examData[cat].items[key]);
                        if (category) {
                            Object.keys(examData[category].items).forEach(itemKey => {
                                catExams[itemKey] = false;
                            });
                        }
                    }
                    
                    catExams[key] = isChecked;

                    if (key === 'biochem') {
                        if (!isChecked) {
                            Object.keys(examData['血液検査'].items).forEach(itemKey => {
                                if (examData['血液検査'].items[itemKey].isOption) {
                                    catExams[itemKey] = false;
                                }
                            });
                        }
                        // 選択状態を更新するためだけに再描画
                        const openAccordions = new Set();
                        document.querySelectorAll('.accordion-content.open').forEach(el => {
                            openAccordions.add(el.previousElementSibling.textContent.trim());
                        });
                        renderExams();
                        document.querySelectorAll('.accordion-header').forEach(header => {
                            if (openAccordions.has(header.textContent.trim())) {
                                header.click();
                            }
                        });
                    }
                    
                    calculateTotal();
                }
            });

            catTabs.addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (button) {
                    state.activeCatIndex = parseInt(button.dataset.catIndex);
                    renderCatTabs();
                    renderExams();
                }
            });
            
            function showDescriptionModal(title, description) {
                modalTitle.textContent = title;
                modalContent.innerHTML = description;
                descriptionModal.classList.remove('hidden');
            }

            examContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('svg');
                    if (content && icon) {
                        content.classList.toggle('open');
                        icon.classList.toggle('rotate-180');
                    }
                }
                const descButton = e.target.closest('.show-description-button');
                if (descButton) {
                    e.preventDefault();
                    showDescriptionModal(descButton.dataset.title, descButton.dataset.description);
                }
            });
            
            showConfirmButton.addEventListener('click', () => {
                renderConfirmation();
                formPage.classList.add('hidden');
                confirmationPage.classList.remove('hidden');
                window.scrollTo(0, 0);
            });

            editButton.addEventListener('click', () => {
                formPage.classList.remove('hidden');
                confirmationPage.classList.add('hidden');
                window.scrollTo(0, 0);
            });
            
            printButton.addEventListener('click', () => {
                window.print();
            });

            finalSubmitButton.addEventListener('click', () => {
                if (!GAS_WEB_APP_URL) {
                    alert('送信先URLが設定されていません。');
                    return;
                }
                
                finalSubmitButton.disabled = true;
                finalSubmitText.classList.add('hidden');
                finalSubmitLoader.classList.remove('hidden');

                fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state),
                })
                .then(() => {
                    confirmationPage.classList.add('hidden');
                    successPage.classList.remove('hidden');
                    window.scrollTo(0, 0);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('送信に失敗しました。ネットワーク接続を確認の上、もう一度お試しください。');
                })
                .finally(() => {
                    finalSubmitButton.disabled = false;
                    finalSubmitText.classList.remove('hidden');
                    finalSubmitLoader.classList.add('hidden');
                });
            });

            returnToFormButton.addEventListener('click', () => {
                window.location.reload();
            });

            descriptionModal.addEventListener('click', (e) => {
                if (e.target === descriptionModal || e.target.closest('.modal-close-button')) {
                    descriptionModal.classList.add('hidden');
                }
            });

            function init() {
                if (state.cats.length === 0) {
                    for (let i = 0; i < state.catCount; i++) {
                        state.cats.push({ name: '', sex: '', age: '', weight: '', exams: {}, symptoms: '', requests: '' });
                    }
                }
                updateStateFromDOM();
                renderCatInfoForms();
                renderCatTabs();
                renderExams();
                calculateTotal();
                lucide.createIcons();
            }

            init();
        });
    </script>
</body>
</html>
